<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title> a mini archive of us üìÅ </title>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@500;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root { --pink: #FAD8D6; --purple: #E6E6FA; --green: #9CD08F; --text: #7B5E7B; --accent: #FDFD96; --white: #FFFFFF; --gray: #f9f3f9; }
        body { background: var(--white); font-family: 'Quicksand', sans-serif; color: var(--text); margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; overflow-x: hidden; touch-action: manipulation; }
        
        /* Smooth Entrance */
        .lvl { width: 100%; display: flex; flex-direction: column; align-items: center; }
        .fade-entrance { animation: fadeIn 0.8s ease-in-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        nav { background: rgba(255, 255, 255, 0.9); padding: 8px; border-radius: 10px; margin-bottom: 15px; font-size: 0.6rem; display: flex; gap: 10px; border: 1px dashed var(--pink); z-index: 100; }
        nav a { cursor: pointer; text-decoration: underline; color: var(--text); }

        .card { background: var(--white); padding: 20px; border-radius: 30px; box-shadow: 0 10px 30px rgba(255, 182, 193, 0.2); width: 95%; max-width: 460px; text-align: center; border: 2px solid var(--pink); margin-bottom: 20px; box-sizing: border-box; }
        .hidden { display: none !important; }
        h2 { margin: 0; color: var(--text); font-size: 1.6rem; }
        .instruction { font-size: 0.8rem; margin: 5px 0 15px 0; opacity: 0.8; font-weight: 500; }
        button { background: var(--green); border: none; padding: 12px 20px; border-radius: 15px; color: white; font-weight: bold; cursor: pointer; margin-top: 15px; transition: 0.3s; }

        /* Stage 1: Connections */
        .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin: 10px 0; width: 100%; }
        .tile { background: var(--purple); padding: 5px; border-radius: 10px; font-size: 0.7rem; font-weight: bold; aspect-ratio: 1; display: flex; align-items: center; justify-content: center; cursor: pointer; text-align: center; }
        .tile.selected { background: var(--pink); color: white; }
        .category-banner { width: 100%; padding: 10px 0; margin-bottom: 8px; border-radius: 12px; font-weight: bold; text-transform: uppercase; font-size: 0.75rem; display: flex; flex-direction: column; align-items: center; animation: popIn 0.4s ease-out; }
        .bg-names { background-color: #f9df6d; } .bg-firsts { background-color: #a0c35a; } .bg-repeat { background-color: #b0c4ef; } .bg-texts { background-color: #ba81c5; color: white; }
        .star { animation: bounce 0.6s infinite alternate; display: inline-block; font-size: 1.5rem; }
        @keyframes bounce { from { transform: translateY(0); } to { transform: translateY(-10px); } }

        /* Stage 2: FIXED LANDSCAPE SCRAMBLE */
        #photo-grid { 
            display: flex; 
            width: 100%; 
            aspect-ratio: 9 / 16 !important; /* This forces Landscape */
            height: auto !important; 
            border-radius: 15px; 
            overflow: hidden; 
            border: 4px solid var(--purple); 
            margin-bottom: 10px; 
        }
        .photo-slice { flex: 1; height: 100%; background-image: url('us.jpg'); background-size: 700% 100%; filter: blur(25px); transition: filter 0.5s; }
        .drop-slot { height: 48px; border: 2px dashed var(--purple); border-radius: 10px; background: #fff; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2rem; }
        .tile-tray { display: flex; justify-content: center; gap: 8px; flex-wrap: wrap; padding: 12px; background: var(--gray); border-radius: 15px; min-height: 70px; width: 100%; box-sizing: border-box; }
        .drag-tile { width: 44px; height: 48px; background: var(--white); border: 2px solid var(--pink); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: bold; cursor: grab; touch-action: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

        /* Memory Lane Gallery */
        .lane-photo { width: 100%; aspect-ratio: 1; border-radius: 12px; background-size: cover; border: 2px solid var(--pink); transition: background-image 1.2s ease-in-out; }

        /* Stage 3: Memory Vault (Optimized 72px) */
        .drawer-container { transition: max-height 0.8s ease-in-out; max-height: 1500px; overflow: hidden; width: 100%; display: flex; flex-direction: column; align-items: center; }
        .drawer-collapsed { max-height: 0; }
        /* UPDATED: 5-Column Grid for perfect alignment */
.mem-grid, .bank-grid { 
    display: grid; 
    grid-template-columns: repeat(5, 1fr); 
    gap: 6px; 
    width: 100%; 
    justify-items: center; 
    margin: 10px 0;
}

/* UPDATED: Locked sizing to prevent "growing" */
.mem-card, .bank-slot { 
    width: 100% !important; 
    aspect-ratio: 1 / 1 !important; /* Forces a perfect square */
    border-radius: 12px; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    transition: transform 0.2s; /* Only animate movement, not size */
    box-sizing: border-box; /* Includes border in the size */
    overflow: hidden; /* Cuts off anything that tries to stick out */
}

/* Specific look for the Memory Cards (Purple) */
/* Specific look for the Memory Cards (Purple) */
.mem-card { 
    background: var(--purple); 
    font-size: 0.55rem; /* Small enough to fit */
    font-weight: 700; 
    padding: 1px;       /* Minimal padding to maximize space */
    text-align: center; 
    line-height: 1.0;   /* Very tight lines */
    border: 2px solid transparent; 
    cursor: pointer;
    user-select: none;
    
    /* Flexbox for centering */
    display: flex;
    align-items: center;
    justify-content: center;

    /* WRAPPING LOGIC */
    white-space: normal;        /* Allow multiple lines */
    overflow-wrap: anywhere;    /* Force break words if they are too long */
    word-break: break-word;     /* Secondary backup for older phones */
}

/* Answer Slot Styling */
.bank-slot { 
    border: 2px solid var(--purple); 
    background: #fafafa; 
    font-weight: bold; 
    font-size: 1.4rem; 
    color: var(--text); 
}

/* Matched State */
.mem-card.matched { 
    color: var(--text); 
    border: 2px solid white; 
    cursor: default; 
    transform: none !important; /* Prevents clicking animation */
}

        /* Stage 4: Wordle Fixed Aspect Ratio */
        .wordle-grid, .keyboard { width: 100%; max-width: 360px; margin: 0 auto; margin-top: 15px}
        .wordle-row { display: grid; grid-template-columns: repeat(6, 1fr); gap: 6px; margin-bottom: 6px; }
        .wordle-cell { aspect-ratio: 1 !important; height: auto !important; border: 2px solid var(--purple); display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.5rem; text-transform: uppercase; border-radius: 10px; transition: 0.6s; background: white; }
        .wordle-cell.correct { background: var(--green); border-color: #a0c35a; transform: rotateX(360deg); }
        .wordle-cell.present { background: var(--accent); border-color: #f9df6d; transform: rotateX(360deg); }
        .wordle-cell.absent { background: var(--gray); border-color: #d3d3d3; color: var(--text); transform: rotateX(360deg); }
        .key { background: var(--gray); border-radius: 6px; padding: 15px 0; min-width: 25px; flex: 1; font-weight: bold; cursor: pointer; font-size: 0.8rem; text-transform: uppercase; user-select: none; }
        .key.correct { background: var(--green); } .key.present { background: var(--accent); } .key.absent { background: var(--gray); color: var(--white); }

        /* UI Styling */
        .hint-row { background: var(--gray); padding: 12px; border-radius: 15px; font-size: 0.75rem; margin: 10px 0; line-height: 1.4; color: var(--text); border-left: 5px solid var(--pink); text-align: left; }
        .pass-input { background: var(--purple); border: 2px solid var(--pink); color: var(--text); padding: 15px; width: 85%; border-radius: 15px; text-align: center; text-transform: uppercase; font-weight: bold; outline: none; margin-bottom: 10px; font-size: 1rem; }
        .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>

    <nav>
    <b>Skip:</b>
    <a onclick="showLvl('access-lvl')">Log</a> <a onclick="showLvl('lvl1')">1</a> <a onclick="showLvl('lvl2')">2</a> 
    <a onclick="showLvl('transition-lvl')">Lane</a> <a onclick="showLvl('lvl3')">3</a> 
    <a onclick="showLvl('lvl4')">4</a> <a onclick="showLvl('win-screen')">End</a>
</nav>

    <div id="access-lvl" class="lvl card">
        <h2>üíò Welcome, C üíò</h2>
        <p class="instruction"> Input password to access ‚ò∫Ô∏é</p>
        <div id="access-hint-box" class="hint-row hidden">üí° <b>Hint:</b> The day we met, 4 digits.</div>
        <input type="text" id="access-input" placeholder="" class="pass-input" style="background: white;">
        <button id="access-hint-btn" style="background:var(--gray); color:var(--text); font-size:0.6rem;" onclick="toggleHint('access-hint-box', 'access-hint-btn')">Show Hint</button> <br>
        <button onclick="checkAccess()">Enter</button>
    </div>

    <div id="lvl1" class="lvl card hidden">
        <h2>üîó Stage 1: Connections üîó</h2>
        <p class="instruction">Some things about us, group them in 4!</p>
        <div class="grid" id="conn-grid"></div>
        <div id="conn-footer">
            <div id="guess-dots" style="margin-top:10px; display:flex; justify-content:center; gap:8px;">
                <span>Mistakes:</span><div class="dot" style="width:10px;height:10px;background:var(--pink);border-radius:50%;"></div><div class="dot" style="width:10px;height:10px;background:var(--pink);border-radius:50%;"></div><div class="dot" style="width:10px;height:10px;background:var(--pink);border-radius:50%;"></div><div class="dot" style="width:10px;height:10px;background:var(--pink);border-radius:50%;"></div>
            </div>
            <button onclick="checkLvl1()">Check Group</button>
        </div>
    </div>

    <div id="lvl2" class="lvl card hidden">
        <h2>üñºÔ∏è Stage 2: Photo Scramble üñºÔ∏è</h2>
        <p class="instruction"> Drag the letters into the correct slots to reveal parts of the photo!</p>
        <div id="photo-grid"></div>
        <div class="slot-container" id="slots" style="display:grid; grid-template-columns:repeat(7,1fr); gap:6px; margin-bottom:15px; width:100%;"></div>
        <div class="tile-tray" id="tray"></div>
        <div id="scramble-finish-area" class="hidden">
            <div style="font-size: 0.9rem; background: white; padding: 15px; border-radius: 15px; margin-top: 15px; border: 2px solid white; color: var(--text);">
                 <b>Btw,</b> I still really like you, a lot.
                 <br><small id="scramble-loading-text" style="opacity: 0.7;">Loading more memories...</small>
                <br><small style="opacity: 0.7;">üíï üíï üíï</small>
            </div>
        </div>
        <div id="scramble-hint-box" class="hint-row hidden">üí° <b>Hint:</b> This is what we said when we were too scared to say 'I love you', we did not know Japanese at the time though!</div>
       <button id="scramble-hint-btn" style="background:var(--purple); color:var(--text); font-size:0.6rem;" onclick="toggleHint('scramble-hint-box', 'scramble-hint-btn')">Show Hint</button>
    </div>

    <div id="transition-lvl" class="lvl card hidden">
        <h2>üåà Memory Lane üåà</h2>
        <p class="instruction">A lil breaky break!</p>
        <div style="display:flex; gap:15px; justify-content:center; margin-bottom:10px;">
            <span class="star">‚òÄÔ∏è</span><span class="star" style="animation-delay: 0.2s;">üåô</span><span class="star" style="animation-delay: 0.4s;">‚ú®</span>
        </div>
        <div class="photo-lane" style="display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin:15px 0; width:100%;">
            <div id="lane-0" class="lane-photo"></div><div id="lane-1" class="lane-photo"></div><div id="lane-2" class="lane-photo"></div>
            <div id="lane-3" class="lane-photo"></div><div id="lane-4" class="lane-photo"></div><div id="lane-5" class="lane-photo"></div>
        </div>
        <div style="font-size:0.85rem; background:var(--gray); padding:15px; border-radius:15px; line-height:1.5; border-left: 5px solid var(--pink);">
            "A quick look back...‚ô°"
        </div>
        <p id="vault-timer" style="font-weight:bold; color:var(--pink); margin-top:15px; font-size:0.9rem;">Loading...</p>
    </div>

    <div id="lvl3" class="lvl card hidden">
        <h2>üóùÔ∏è Stage 3: The Vault üóùÔ∏è</h2>
        <p class="instruction">Match the pairs to reveal secret letters for your bank, unscramble them to get the password to move on to the final stage!</p>
        <div id="mem-drawer" class="drawer-container"><div class="mem-grid" id="mem-grid"></div></div>
        <button id="drawer-toggle" class="hidden" style="font-size:0.6rem; background:var(--purple); color:var(--text);" onclick="toggleDrawer()">Show Match History</button>
        <div style="margin-top:15px; border-top:2px solid var(--pink); padding-top:10px; width:100%;">
            <p style="font-size: 0.7rem; font-weight: bold; color: var(--text);"> UNLOCKED LETTERS:</p>
            <div class="bank-grid" id="bank-grid"></div>
            <div id="vault-hint-box" class="hint-row hidden">üí° <b>Hint:</b> Our tattoos, no spaces! </div>
       <button id="vault-hint-btn" class="hidden" style="background:var(--purple); color:var(--text); font-size:0.6rem;" onclick="toggleHint('vault-hint-box', 'vault-hint-btn')">Show Hint</button> <br>
            <div class="hidden" id="password-box" style="margin-top: 15px;"></div>
                <input type="text" id="pass-input" placeholder=" " class="pass-input" style="background:white;">
                <button id="vault-submit-btn" onclick="submitSecret()">Enter</button>
            </div>
        </div>
    </div>

    <div id="lvl4" class="lvl card hidden">
        <h2>üéâ Final Stage: Super Wordle üéâ</h2>
        <p class="instruction">Wordle, but 6 letters ‚≠êÔ∏é</p>
        <div id="wordle-hint-box" class="hint-row hidden">üí° <b>Note:</b> Not a word. üòî Try another!</div>
        <div class="wordle-grid" id="wordle-grid"></div> 
        <div class="keyboard" id="keyboard" style="display:flex; flex-direction:column; gap:5px; width:100%;"></div>
    </div>

    <div id="win-screen" class="lvl card hidden">
        <h1>üíñ Happy 6 Years! üíñ</h1>
        <div id="letter-content" style="text-align:left; line-height:1.6; font-size:0.9rem; background:#fff9fa; padding:20px; border-radius:20px; border-left: 6px solid var(--pink);">
            <p>Dear Cam, </p>
            <p>I hope you enjoyed this! I had a lot of fun putting it together, and it was nice to think back on all the things we've done together. </p>
            <p>I feel like I've experienced so many things since we met that I wouldn't have ever come close to if it wasn't for you. You've changed my life for the better, and I look forward to all the new things that will continue coming to me, all because I met you.</p>
            <p>I know that both our relationship dynamics and us as individuals have changed in many ways since we first met, but I want you to know that you're still my favorite person. You're still the one that I want to be with all the way until the end. 
            <p>I hope for us to continue growing together and building a life where we can share so many more experiences. I know life is just life sometimes, but doing it with you makes everything easier. Thank you for showing me a life I never even thought of having. I love you!</p>
            <p>‚Äî Jas </p>
        </div>
        <button onclick="window.location.href=window.location.href">Re-Start Archive üîÑ</button>
    </div>

<script>
    const accessPass = "0214", passTarget = "BABYCUPIDS", targetWord = "LOVERS", secretPhrase = "DAISUKI";
    const categories = {
        "NAMES": { words: ["STINKY", "CUTIE PATOOTIE", "MEANIE BO BEANIE", "CHONKY"], color: "bg-names", label: "STUFF WE CALL YUE" },
        "FIRSTS": { words: ["VALENTINES DAY", "MARYLAND", "SUMMIT", "STEVEN UNIVERSE"], color: "bg-firsts", label: "SOME OF OUR FIRSTS" },
        "REPEAT": { words: ["SOMEONE GREAT", "BROAD CITY", "BROOKLYN 99", "LOTR"], color: "bg-repeat", label: "ON REPEAT" },
        "TEXTS": { words: ["HELLO", "SO SLEEPY", "COMING HOME", "*PIC OF YUE*"], color: "bg-texts", label: "THINGS YOU TEXT ME" }
    };
    const memoryPairs = [
        { word: "THE PHOTOGRAPHER", hint: "OUR FIRST MOVIE", letter: "B" }, { word: "AVATAR CONCERT", hint: "FAV MEMORY", letter: "A" },
        { word: "YOUR LOTR HEAR ME OUT", hint: "THORIN", letter: "B" }, { word: "YES", hint: "DYNAMIC_Q10", letter: "Y" },
        { word: "CHARCUTERIE", hint: "OUR HOLIDAY MEAL", letter: "C" }, { word: "SUMMIT", hint: "OUR FIRST PLACE", letter: "U" },
        { word: "POPCORN", hint: "YOUR FAV PART OF MOVIES", letter: "P" }, { word: "LILIANAS", hint: "FARMERS MARKET FAV", letter: "I" },
        { word: "SAVANNAH", hint: "ANNIVERSARY TRIP", letter: "D" }, { word: "BOARD GAMES", hint: "ONE OF OUR HOBBIES", letter: "S" }
    ];
    const photoSets = [ { a: '1a.jpg', b: '1b.jpg' }, { a: '2a.jpg', b: '2b.jpg' }, { a: '3a.jpg', b: '3b.jpg' }, { a: '4a.jpg', b: '4b.jpg' }, { a: '5a.jpg', b: '5b.jpg' }, { a: '6a.jpg', b: '6b.jpg' } ];

    let mistakes = 0, solvedCats = 0, scramProg = 0, matches = 0, wordleAt = 0, curGuess = "", firstCard = null, secondCard = null, draggedTile = null, cycleActive = false;

    function showLvl(id) {
        document.querySelectorAll('.lvl').forEach(l => {
            l.classList.add('hidden');
            l.classList.remove('fade-entrance');
        });
        const active = document.getElementById(id);
        active.classList.remove('hidden');
        active.classList.add('fade-entrance');
        
        if(id === 'lvl1') setupConnections(); if(id === 'lvl2') setupScramble();
        if(id === 'transition-lvl') { startPhotoCycle(); runAutoVaultTimer(); }
        if(id === 'lvl3') setupMemory(); if(id === 'lvl4') setupWordle();
    }

   function toggleHint(boxId, btnId) {
    const box = document.getElementById(boxId); 
    const btn = document.getElementById(btnId);
    box.classList.toggle('hidden');
    
    // UPDATED: Now uses lowercase text
    btn.innerText = box.classList.contains('hidden') ? "Show Hint" : "Hide Hint";
}

    function checkAccess() {
        if(document.getElementById('access-input').value.toUpperCase().trim() === accessPass) showLvl('lvl1');
        else { document.getElementById('access-lvl').classList.add('shake'); setTimeout(()=>document.getElementById('access-lvl').classList.remove('shake'), 400); }
    }

    // Stage 1
    function setupConnections() {
        const grid = document.getElementById('conn-grid'); grid.innerHTML = ""; solvedCats = 0; mistakes = 0;
        document.querySelectorAll('.category-banner').forEach(b => b.remove());
        const all = Object.values(categories).flatMap(c => c.words).sort(() => Math.random() - 0.5);
        all.forEach(w => { 
            const d = document.createElement('div'); d.className = 'tile'; d.innerText = w; 
            d.onclick = () => { if(document.querySelectorAll('.tile.selected').length < 4 || d.classList.contains('selected')) d.classList.toggle('selected'); }; 
            grid.appendChild(d); 
        });
    }

    function checkLvl1() {
        const sel = document.querySelectorAll('.tile.selected'); if(sel.length !== 4) return;
        const words = Array.from(sel).map(t => t.innerText); let match = false;
        for (const [k, d] of Object.entries(categories)) {
            if (d.words.every(w => words.includes(w))) {
                match = true; const banner = document.createElement('div'); banner.className = `category-banner ${d.color}`;
                banner.innerHTML = `<span>${d.label}</span><small>${d.words.join(', ')}</small>`;
                document.getElementById('conn-grid').parentNode.insertBefore(banner, document.getElementById('conn-grid'));
                sel.forEach(t => t.remove()); solvedCats++; break;
            }
        }
        if(!match) { 
            mistakes++; const dots = document.querySelectorAll('.dot'); if(dots[mistakes-1]) dots[mistakes-1].style.opacity = "0.2";
            sel.forEach(t => { t.classList.add('shake'); setTimeout(()=>t.classList.remove('shake','selected'), 400); }); 
            if(mistakes===4) setupConnections();
        }
        if(solvedCats === 4) {
            const footer = document.getElementById('conn-footer'); footer.innerHTML = `<div style="display:flex; justify-content:center; gap:12px; margin-top:15px;"></div>`;
            for(let i=0; i<(4-mistakes); i++) { 
                const s = document.createElement('span'); s.className='star'; s.innerText='‚≠ê'; 
                s.style.animationDelay=(i*0.1)+'s'; footer.firstChild.appendChild(s); 
            }
            setTimeout(() => showLvl('lvl2'), 2500);
        }
    }

    // Stage 2
    
function setupScramble() {
    const pg = document.getElementById('photo-grid'), 
          sl = document.getElementById('slots'), 
          tr = document.getElementById('tray');
          
    pg.innerHTML = ""; sl.innerHTML = ""; tr.innerHTML = ""; scramProg = 0;
    
    tr.classList.remove('hidden'); 
    document.getElementById('scramble-hint-btn').classList.remove('hidden');
    document.getElementById('scramble-finish-area').classList.add('hidden');

    // Create the photo slices in strict 0-6 order (no randomization here)
    for(let i=0; i<7; i++) {
        let slice = document.createElement('div'); 
        slice.className = 'photo-slice'; 
        slice.style.backgroundPosition = `${(i/6)*100}% 0%`; 
        pg.appendChild(slice);

        let slot = document.createElement('div'); 
        slot.className = 'drop-slot'; 
        slot.dataset.index = i; 
        slot.addEventListener('dragover', (e) => e.preventDefault()); 
        slot.addEventListener('drop', (e) => handleDrop(e, i)); 
        sl.appendChild(slot);
    }
    
    // SCRAMBLE THE TEXT: Shuffle the letters for the tray only
    let letters = secretPhrase.split(''); 
    let shuffled;
    do { 
        shuffled = [...letters].sort(() => Math.random() - 0.5); 
    } while (shuffled.some((char, idx) => char === letters[idx]));

    shuffled.forEach(c => {
        let t = document.createElement('div'); 
        t.className = 'drag-tile'; 
        t.innerText = c; 
        t.draggable = true;
        t.addEventListener('dragstart', () => draggedTile = t); 
        t.addEventListener('touchstart', () => draggedTile = t); 
        tr.appendChild(t);
    });

    // Mobile Support
    sl.addEventListener('touchend', (e) => {
        if(!draggedTile) return; 
        const touch = e.changedTouches[0]; 
        const target = document.elementFromPoint(touch.clientX, touch.clientY);
        const slot = target ? target.closest('.drop-slot') : null; 
        if(slot) handleDrop(null, parseInt(slot.dataset.index));
    });
}

function handleDrop(e, slotIdx) {
    if(e) e.preventDefault(); 
    if(!draggedTile) return;

    if(draggedTile.innerText === secretPhrase[slotIdx]) {
        const slot = document.getElementById('slots').children[slotIdx];
        slot.innerText = draggedTile.innerText; 
        slot.style.background = "var(--green)";
        
        // REVEAL IN ORDER: This now clears the blur for the exact slice just filled
        document.getElementById('photo-grid').children[slotIdx].style.filter = "blur(0)";
        
        draggedTile.remove(); 
        draggedTile = null; 
        scramProg++;
        
        if(scramProg === 7) {
            document.getElementById('tray').classList.add('hidden');
            document.getElementById('scramble-hint-btn').classList.add('hidden');
            document.getElementById('scramble-finish-area').classList.remove('hidden');
            
            // 10-second timer for the reveal
            setTimeout(() => showLvl('transition-lvl'), 10000); 
        }
    } else { 
        draggedTile.classList.add('shake'); 
        setTimeout(() => draggedTile.classList.remove('shake'), 400); 
        draggedTile = null; 
    }
}

    // Stage 3
    function setupMemory() {
        const grid = document.getElementById('mem-grid'), bank = document.getElementById('bank-grid');
        grid.innerHTML = ""; bank.innerHTML = ""; matches = 0;
        for(let i=0; i<10; i++) { let s = document.createElement('div'); s.className = 'bank-slot'; bank.appendChild(s); }
        const cards = []; memoryPairs.forEach((p, i) => { cards.push({ v: p.word, id: i }, { v: p.hint, id: i }); });
        cards.sort(() => Math.random() - 0.5).forEach(c => {
            const d = document.createElement('div'); d.className = 'mem-card'; d.dataset.id = c.id;
            d.onclick = () => {
                if(d.classList.contains('matched') || d === firstCard || secondCard) return;
                d.innerText = c.v === "DYNAMIC_Q10" ? ["ARE YOU MY FAVE?", "DO YOU LOVE ME?", "BE MY VALENTINE?", "ARE YOU THE CUTEST?"][Math.floor(Math.random()*4)] : c.v;
                if(!firstCard) firstCard = d;
                else { secondCard = d; if(firstCard.dataset.id === secondCard.dataset.id) {
                    setTimeout(() => {
                        const colors = ['#FFD1DC', '#E2F0CB', '#B0C4EF', '#FFECB3', '#E6E6FA', '#F9E4AD', '#D1F2EB', '#F5CBA7', '#D7BDE2', '#AED6F1'];
                        firstCard.classList.add('matched'); secondCard.classList.add('matched');
                        firstCard.style.backgroundColor = colors[matches]; secondCard.style.backgroundColor = colors[matches];
                        document.querySelectorAll('.bank-slot')[matches].innerText = memoryPairs[firstCard.dataset.id].letter;
                        firstCard = null; secondCard = null; matches++;
                        if (matches === 10) { 
                            document.getElementById('mem-drawer').classList.add('drawer-collapsed');
                            document.getElementById('drawer-toggle').classList.remove('hidden');
                            document.getElementById('password-box').classList.remove('hidden');
                            document.getElementById('vault-hint-btn').classList.remove('hidden');
                        }
                    }, 500);
                } else { setTimeout(() => { firstCard.innerText = ''; secondCard.innerText = ''; firstCard = null; secondCard = null; }, 1000); }
                }
            }; grid.appendChild(d);
        });
    }

    function toggleDrawer() { document.getElementById('mem-drawer').classList.toggle('drawer-collapsed'); }
    
   function submitSecret() {
    const inputField = document.getElementById('pass-input');
    const inputVal = inputField.value.toUpperCase().trim();
    const vaultLvl = document.getElementById('lvl3');
    const passBox = document.getElementById('password-box');
    const submitBtn = document.getElementById('vault-submit-btn'); // Targets the button

    if (inputVal === passTarget) {
        // Hides the input field, the hint button, AND the submit button instantly
        passBox.classList.add('hidden'); 
        if(submitBtn) submitBtn.classList.add('hidden'); 
        document.getElementById('vault-hint-btn').classList.add('hidden');
        document.getElementById('drawer-toggle').classList.add('hidden');

        // Create the Star Transition element
        const starDiv = document.createElement('div');
        starDiv.style.marginTop = "30px";
        starDiv.style.animation = "fadeIn 0.5s ease-in-out";
        starDiv.innerHTML = `
            <div style="display:flex; justify-content:center; gap:15px; margin-bottom:12px;">
                <span class="star">‚≠ê</span>
                <span class="star" style="animation-delay:0.2s;">‚≠ê</span>
                <span class="star" style="animation-delay:0.4s;">‚≠ê</span>
            </div>
            <p style="font-weight:bold; color:var(--pink); font-size:1rem; letter-spacing:1px;">
                VAULT DECRYPTED. STANDBY...
            </p>
        `;
        
        // Add stars to the card
        vaultLvl.appendChild(starDiv);

        // Wait 4 seconds before moving to Wordle
        setTimeout(() => {
            showLvl('lvl4');
        }, 4000);

    } else {
        // Shake animation for incorrect password
        vaultLvl.classList.add('shake');
        setTimeout(() => vaultLvl.classList.remove('shake'), 400);
    }
}
    // Stage 4
    function setupWordle() {
        const g = document.getElementById('wordle-grid'), k = document.getElementById('keyboard');
        g.innerHTML = ""; k.innerHTML = ""; wordleAt = 0; curGuess = "";
        for (let i = 0; i < 6; i++) {
            const r = document.createElement('div'); r.className = 'wordle-row';
            for (let j = 0; j < 6; j++) { const c = document.createElement('div'); c.className = 'wordle-cell'; r.appendChild(c); }
            g.appendChild(r);
        }
        const lay = [ ["q", "w", "e", "r", "t", "y", "u", "i", "o", "p"], ["a", "s", "d", "f", "g", "h", "j", "k", "l"], ["del", "z", "x", "c", "v", "b", "n", "m", "ent"] ];
        lay.forEach(rowArr => {
            const r = document.createElement('div'); r.style.display="flex"; r.style.justifyContent="center"; r.style.gap="4px"; r.style.marginBottom="5px";
            rowArr.forEach(key => {
                const ky = document.createElement('div'); ky.className = 'key' + (key.length > 1 ? ' wide' : ''); ky.id = 'k-' + key; ky.innerText = key;
                ky.onclick = () => {
                    if(key === 'del') curGuess = curGuess.slice(0, -1);
                    else if(key === 'ent' && curGuess.length === 6) validateWordle();
                    else if(curGuess.length < 6 && key.length === 1) curGuess += key.toUpperCase();
                    const rCells = g.children[wordleAt].children; for(let i=0; i<6; i++) rCells[i].innerText = curGuess[i] || "";
                }; r.appendChild(ky);
            }); k.appendChild(r);
        });
    }

    async function validateWordle() {
        if (curGuess === targetWord) { submitWordle(); return; }
        try {
            const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${curGuess.toLowerCase()}`);
            if (res.ok) submitWordle();
            else { 
                const box = document.getElementById('wordle-hint-box'); 
                box.classList.remove('hidden'); 
                const card = document.getElementById('lvl4');
                card.classList.remove('fade-entrance'); // Temporarily stop fade
                card.classList.add('shake'); 
                setTimeout(() => { card.classList.remove('shake'); box.classList.add('hidden'); }, 1500); 
            }
        } catch (e) { submitWordle(); }
    }

    function submitWordle() {
    const r = document.getElementById('wordle-grid').children[wordleAt], cells = r.children;
    for (let i = 0; i < 6; i++) {
        const char = curGuess[i]; const key = document.getElementById('k-' + char.toLowerCase());
        setTimeout(() => {
            if (char === targetWord[i]) { cells[i].classList.add('correct'); key.classList.add('correct'); }
            else if (targetWord.includes(char)) { cells[i].classList.add('present'); if(!key.classList.contains('correct')) key.classList.add('present'); }
            else { cells[i].classList.add('absent'); key.classList.add('absent'); }
        }, i * 150);
    }

    if (curGuess === targetWord) {
        setTimeout(() => {
            // 1. Hide the keyboard to clear the screen
            document.getElementById('keyboard').classList.add('hidden');
            
            // 2. Create the final reveal button
            const wordleCard = document.getElementById('lvl4');
            const revealBtn = document.createElement('button');
            
            // 3. APPLY FADE-IN: We use the existing class from your CSS
            revealBtn.className = "fade-entrance"; 
            
            revealBtn.innerText = "open newest archive log üíå";
            revealBtn.style.marginTop = "25px";
            revealBtn.style.padding = "15px 30px";
            revealBtn.style.width = "100%";
            
            revealBtn.onclick = () => showLvl('win-screen');
            wordleCard.appendChild(revealBtn);
        }, 1500);
    } else { 
        wordleAt++; 
        curGuess = ""; 
        if (wordleAt === 6) setTimeout(resetWordle, 1500); 
    }
}

    function resetWordle() {
        wordleAt = 0; curGuess = "";
        document.querySelectorAll('.wordle-cell').forEach(c => { c.innerText = ""; c.className = "wordle-cell"; });
        document.querySelectorAll('.key').forEach(k => k.classList.remove('correct', 'present', 'absent'));
    }

    function startPhotoCycle() {
        if (cycleActive) return; cycleActive = true;
        photoSets.forEach((set, i) => { const el = document.getElementById(`lane-${i}`); if(el) el.style.backgroundImage = `url('${set.a}')`; });
        setInterval(() => { photoSets.forEach((set, i) => { const el = document.getElementById(`lane-${i}`); if(el) el.style.backgroundImage = `url('${Math.random() > 0.5 ? set.b : set.a}')`; }); }, 2500);
    }

    function runAutoVaultTimer() {
        let count = 20; const timerText = document.getElementById('vault-timer');
        const itv = setInterval(() => { count--; if (timerText) timerText.innerText = `${count}s...`; if(count === 0) { clearInterval(itv); showLvl('lvl3'); } }, 1000);
    }

    window.onload = () => showLvl('access-lvl');
</script>
</body>
</html>